name: Update Index Files

on:
  push:
    branches:
      - main
    paths:
      - 'events/**/*.json'
      - '!events/**/index.json'

permissions:
  contents: write

jobs:
  update-indices:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Generate index files
        run: |
          python3 << 'EOF'
          import os
          import json
          from pathlib import Path

          EVENTS_DIR = Path("events")
          
          def generate_indices():
              events_by_year = {}
              
              # Scan all event JSONs
              for json_file in EVENTS_DIR.rglob("*.json"):
                  # Skip index files
                  if json_file.name == "index.json":
                      continue
                  
                  try:
                      with open(json_file, 'r', encoding='utf-8') as f:
                          event_data = json.load(f)
                      
                      # Validate required fields
                      if "event_id" not in event_data or "date" not in event_data:
                          print(f"Skipping invalid file: {json_file}")
                          continue
                      
                      year = event_data["date"][:4]
                      if year not in events_by_year:
                          events_by_year[year] = []
                      
                      # Create summary object
                      summary = {
                          "event_id": event_data["event_id"],
                          "event_name": event_data["event_name"],
                          "date": event_data["date"],
                          "venue": event_data["venue"],
                          "path": f"/events/{year}/{json_file.name}"
                      }
                      events_by_year[year].append(summary)
                      
                  except Exception as e:
                      print(f"Error processing {json_file}: {e}")

              # Generate year-specific index.json
              years = sorted(events_by_year.keys())
              for year in years:
                  year_dir = EVENTS_DIR / year
                  year_dir.mkdir(parents=True, exist_ok=True)
                  
                  # Sort events by date
                  events_by_year[year].sort(key=lambda x: x["date"])
                  
                  index_path = year_dir / "index.json"
                  with open(index_path, 'w', encoding='utf-8') as f:
                      json.dump(events_by_year[year], f, indent=2, ensure_ascii=False)
                  print(f"âœ… Generated index for {year}: {len(events_by_year[year])} events")

              # Generate main index.json (list of years)
              main_index_path = EVENTS_DIR / "index.json"
              main_index_data = {"years": years}
              with open(main_index_path, 'w', encoding='utf-8') as f:
                  json.dump(main_index_data, f, indent=2, ensure_ascii=False)
              print(f"âœ… Generated main index.json with years: {years}")

          if __name__ == "__main__":
              generate_indices()
          EOF
      
      - name: Check for changes
        id: check_changes
        run: |
          git diff --quiet events/**/index.json || echo "changed=true" >> $GITHUB_OUTPUT
      
      - name: Commit and push if changed
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add events/**/index.json
          git commit -m "chore: auto-update index files"
          git push
      
      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages
      
      - name: Sync events directory to gh-pages
        run: |
          # Remove existing events directory in gh-pages
          rm -rf gh-pages/events
          
          # Copy events directory from main to gh-pages (with updated index.json)
          cp -r events gh-pages/events
          
          echo "âœ… Synced events/ directory to gh-pages"
      
      - name: Commit and push to gh-pages
        run: |
          cd gh-pages
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add events
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit to gh-pages"
          else
            git commit -m "ðŸ”„ Sync events/ from main branch (with updated index.json)"
            git push origin gh-pages
            echo "âœ… Successfully pushed to gh-pages"
          fi
