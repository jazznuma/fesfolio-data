name: Update Index Files

on:
  push:
    branches:
      - main
    paths:
      - 'events/**/*.json'
      - '!events/**/index.json'

jobs:
  update-indices:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Generate index files
        run: |
          python3 << 'EOF'
          #ï¼ˆä¸­èº«ã¯ã‚ãªãŸã®ã‚³ãƒ¼ãƒ‰ãã®ã¾ã¾ï¼‰
          import os
          import json
          from pathlib import Path

          EVENTS_DIR = Path("events")
          
          def generate_indices():
              events_by_year = {}
              
              # Scan all event JSONs
              for json_file in EVENTS_DIR.rglob("*.json"):
                  if json_file.name == "index.json":
                      continue
                  
                  try:
                      with open(json_file, 'r', encoding='utf-8') as f:
                          event_data = json.load(f)

                      if "event_id" not in event_data or "date" not in event_data:
                          print(f"Skipping invalid file: {json_file}")
                          continue

                      year = event_data["date"][:4]
                      if year not in events_by_year:
                          events_by_year[year] = []

                      summary = {
                          "event_id": event_data["event_id"],
                          "event_name": event_data["event_name"],
                          "date": event_data["date"],
                          "venue": event_data["venue"],
                          "path": f"/events/{year}/{json_file.name}"
                      }
                      events_by_year[year].append(summary)

                  except Exception as e:
                      print(f"Error processing {json_file}: {e}")

              years = sorted(events_by_year.keys())
              for year in years:
                  year_dir = EVENTS_DIR / year
                  year_dir.mkdir(parents=True, exist_ok=True)
                  events_by_year[year].sort(key=lambda x: x["date"])
                  
                  index_path = year_dir / "index.json"
                  with open(index_path, 'w', encoding='utf-8') as f:
                      json.dump(events_by_year[year], f, indent=2, ensure_ascii=False)
                  print(f"Generated index for {year}: {len(events_by_year[year])} events")

              main_index_path = EVENTS_DIR / "index.json"
              main_index_data = {"years": years}
              with open(main_index_path, 'w', encoding='utf-8') as f:
                  json.dump(main_index_data, f, indent=2, ensure_ascii=False)
              print(f"Generated main index.json with years: {years}")

          if __name__ == "__main__":
              generate_indices()
          EOF

      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      # ğŸ‘‡ main ã«ç›´æ¥ push ã›ãšã€PR ã‚’ä½œæˆã™ã‚‹
      - name: Create Pull Request
        if: steps.check_changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.PAT_FOR_PR }}
          commit-message: "chore: auto-update index files"
          title: "Auto update index files"
          body: "This PR was automatically generated because event index files changed."
          branch: "auto/update-index"
          base: "main"
          delete-branch: true
